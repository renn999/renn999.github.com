<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <title>東方輝針城BGM解出 - 老伯筆記</title>
  <meta name="author" content="renn999">
  <meta name="description" content="我是廢話 大家好，老實說我已經一段時間沒有更新我的 Blog 了，感覺上除了霉味外，我還看見了一大堆菇菇長出來了，當然自從有了工作以後真的時間並沒有比較多，應該說在工作性質的關係整天盯著螢幕真的回家後，看到有鍵盤的東西就一整個賭爛（嘆~！）。 正題開始 前幾天，東方例大祭 10 剛結束，當然神主 Z...">
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link href="http://feeds.feedburner.com/renn999" rel="alternate" title="老伯筆記" type="application/atom+xml">
  <link rel="canonical" href="">
  <link href="/favicon.ico" rel="shortcut icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
</head>
<body>
  <header id="header" class="inner"><h1><a href="/">老伯筆記</a></h1>
<nav id="main-nav"><ul class="main">
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/guestbook/">留言板</a></li>
  <li><a href="http://illust.renn999.twbbs.org/">老伯繪師收集區</a></li>
</ul></nav>
<nav id="mobile-nav">
  <div class="alignleft menu">
    <a class="button">Menu</a>
    <div class="container"><ul class="main">
  <li><a href="/archives/">Archives</a></li>
  <li><a href="/guestbook/">留言板</a></li>
  <li><a href="http://illust.renn999.twbbs.org/">老伯繪師收集區</a></li>
</ul></div>
  </div>
  <div class="alignright search">
    <a class="button"></a>
    <div class="container">
      <form action="http://google.com/search" method="get">
        <input type="text" name="q" results="0">
        <input type="hidden" name="q" value="site:www.renn999.twbbs.org">
      </form>
    </div>
  </div>
</nav>
<nav id="sub-nav" class="alignright">
  <div class="social">
  	
  	<a class="plurk" href="http://www.plurk.com/renn999" title="plurk">plurk</a>
  	
    
    <a class="facebook" href="http://www.facebook.com/renn999" title="Facebook">Facebook</a>
    
    
    <a class="google" href="https://plus.google.com/103389845925471617368?rel=author" title="Google+">Google+</a>
    
    
    <a class="twitter" href="http://twitter.com/renn999" title="Twitter">Twitter</a>
    
    
    <a class="github" href="https://github.com/renn999" title="GitHub">GitHub</a>
    
    
    
    
    
    <a class="rss" href="http://feeds.feedburner.com/renn999" title="RSS">RSS</a>
    
  </div>
  <form class="search" action="http://google.com/search" method="get">
    <input class="alignright" type="text" name="q" results="0">
    <input type="hidden" name="q" value="site:www.renn999.twbbs.org">
  </form>
</nav></header>
  <div id="content" class="inner">
  
    
    <article class="post">
    
      

<h1 class="title"><a href="/archives/917/">東方輝針城BGM解出

</a></h1>

<div class="entry-content">
  
    <h1>我是廢話</h1>
<p>大家好，老實說我已經一段時間沒有更新我的 Blog 了，感覺上除了霉味外，我還看見了一大堆菇菇長出來了，當然自從有了工作以後真的時間並沒有比較多，應該說在工作性質的關係整天盯著螢幕真的回家後，看到有鍵盤的東西就一整個賭爛（嘆~！）。</p>
<h1>正題開始</h1>
<p>前幾天，東方例大祭 10 剛結束，當然神主 <a href="http://kourindou.exblog.jp/">ZUN</a> 也放出了新的試玩版，剛好手很癢的也去試玩了一下，但是我真的是彈幕苦手啊 QAQ... 老實說這不是重點...</p>
<p><a target="_blank" href="http://minus.com/lMCLB0nlb5L6U"><img src="http://i.minus.com/jMCLB0nlb5L6U.png" border="0"/></a></p>
<!--more-->

<h1>這才是重點</h1>
<p>老實說，沒次一看到一個有幸去的東西都會想要把他解剖出來看，就跟之前幫迷ゲーム解圖的感覺一樣，但是這只是讓我純粹筆記用，是不是有參考價值，老實說，網路上已經有一堆可以解 BGM 的程式了，我還在造輪子 ... OTZ，就只是好玩。而且這些資訊都是 google 來的，反正需要就參考吧，我只是把整個流程整理出來而已。</p>
<h2>行前動作</h2>
<p>這次的重點主要放在兩個檔案上 <code>th14tr.dat</code> 及 <code>thbgm_tr.dat</code>，但是重點還是 <code>th14tr.dat</code> 上，這是整個遊戲的腳本檔及特殊音效等都放在這裡，但是要解出來還是要靠特殊的程式 <a href="https://mega.co.nz/#!oIIX1ZRS!F9FBNygp27iGZo08BX4Hs1s50nlZIQCohbEZe0DCmls">BrightMoon</a> 這是一隻專門解出東方系列作品素材的程式，還好可以在 <code>wine</code> 底下運作無誤，因為這次的重點是 BGM 解出，其他的音效應該很容易吧。打開後會需要兩個檔案 <code>thbgm_tr.fmt</code> 及 <code>musiccmt_tr.txt</code>，先說 <code>musiccmt_tr.txt</code> 其實這只是音樂的標題及簡短介紹，我只是懶得打所以才解出來而已。</p>
<p>因為在 <code>thbgm_tr.dat</code> 這個檔案的開頭 4 bytes 就只有 <code>ZWAV</code> 而整串都是 PCM ，靠得就是 <code>th14tr.dat/thbgm_tr.fmt</code> 這個檔案 info 說何時要 loop ，如果用 <code>Hexedit</code> 等工具看到的話就會是這種狀況：</p>
<pre><code>00000000   74 68 31 34  5F 30 31 2E  77 61 76 00  00 00 00 00  th14_01.wav.....
00000010   10 00 00 00  60 2F 3D 01  D0 AD 2B 00  60 2F 3D 01  ....`/=...+.`/=.
00000020   01 00 02 00  44 AC 00 00  10 B1 02 00  04 00 10 00  ....D...........
00000030   00 00 00 00  74 68 31 34  5F 30 32 2E  77 61 76 00  ....th14_02.wav.
00000040   00 00 00 00  70 2F 3D 01  00 29 F9 00  C0 D8 15 00  ....p/=..)......
00000050   00 29 F9 00  01 00 02 00  44 AC 00 00  10 B1 02 00  .)......D.......
00000060   04 00 10 00  00 00 00 00  74 68 31 34  5F 30 33 2E  ........th14_03.
00000070   77 61 76 00  00 00 00 00  70 58 36 02  00 30 F1 00  wav.....pX6..0..
00000080   80 51 06 00  00 30 F1 00  01 00 02 00  44 AC 00 00  .Q...0......D...
00000090   10 B1 02 00  04 00 10 00  00 00 00 00  74 68 31 34  ............th14
000000A0   5F 30 34 2E  77 61 76 00  00 00 00 00  70 88 27 03  _04.wav.....p.'.
000000B0   70 8A 12 01  80 24 29 00  70 8A 12 01  01 00 02 00  p....$).p.......
000000C0   44 AC 00 00  10 B1 02 00  04 00 10 00  00 00 00 00  D...............
000000D0   74 68 31 34  5F 30 35 2E  77 61 76 00  00 00 00 00  th14_05.wav.....
000000E0   E0 12 3A 04  E0 11 23 01  30 A1 05 00  E0 11 23 01  ..:...#.0.....#.
000000F0   01 00 02 00  44 AC 00 00  10 B1 02 00  04 00 10 00  ....D...........
00000100   00 00 00 00  74 68 31 34  5F 30 36 2E  77 61 76 00  ....th14_06.wav.
00000110   00 00 00 00  C0 24 5D 05  90 C5 85 01  F0 02 0F 00  .....$].........
00000120   90 C5 85 01  01 00 02 00  44 AC 00 00  10 B1 02 00  ........D.......
00000130   04 00 10 00  00 00 00 00  74 68 31 34  5F 30 37 2E  ........th14_07.
00000140   77 61 76 00  00 00 00 00  50 EA E2 06  80 22 1D 01  wav.....P...."..
00000150   40 CF 23 00  80 22 1D 01  01 00 02 00  44 AC 00 00  @.#.."......D...
00000160   10 B1 02 00  04 00 10 00  00 00 00 00  74 68 31 32  ............th12
---  thbgm_tr.fmt       --0x0/0x1B1--------------------------------------------
generate by Hexedit</code></pre>

<p>可以很清楚的看出規律，其實就是 52bytes 一個 block ，另外寫一隻 python 讓整個看起來更有規律：</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'> 1</span>
<span class='line-number'> 2</span>
<span class='line-number'> 3</span>
<span class='line-number'> 4</span>
<span class='line-number'> 5</span>
<span class='line-number'> 6</span>
<span class='line-number'> 7</span>
<span class='line-number'> 8</span>
<span class='line-number'> 9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span></pre></td><td class='code'><pre><code><span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">8</span><span class="p">):</span></span>
<span class='line'>    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">i</span><span class="o">*</span><span class="mi">52</span><span class="p">)</span></span>
<span class='line'>    <span class="n">j</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">52</span><span class="p">)</span></span>
<span class='line'>    <span class="n">k</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s">&#39;16s4s4s4s4s4s4s4s4s4s&#39;</span><span class="p">,</span> <span class="n">j</span><span class="p">))</span></span>
<span class='line'>    <span class="n">t</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span></span>
<span class='line'>    <span class="n">lsta</span><span class="o">=</span><span class="p">[]</span></span>
<span class='line'>    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">k</span><span class="p">:</span></span>
<span class='line'>        <span class="n">lst</span><span class="o">=</span><span class="p">[]</span></span>
<span class='line'>        <span class="k">for</span> <span class="n">ch</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span></span>
<span class='line'>            <span class="n">hv</span> <span class="o">=</span> <span class="nb">hex</span><span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="n">ch</span><span class="p">))</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;0x&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span></span>
<span class='line'>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">hv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span></span>
<span class='line'>                <span class="n">hv</span> <span class="o">=</span> <span class="s">&#39;0&#39;</span><span class="o">+</span><span class="n">hv</span></span>
<span class='line'>            <span class="n">lst</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">hv</span><span class="p">)</span></span>
<span class='line'>        <span class="n">lsta</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lst</span><span class="p">))</span></span>
<span class='line'>    <span class="k">print</span> <span class="n">t</span><span class="p">,</span> <span class="s">&#39;  &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lsta</span><span class="p">)</span></span>
<span class='line'></span></code></pre></td></tr></table></div></figure>


<p>解出後就是這樣子：
<pre><code>
   name        seek         full         intro        full      以下unknow
                            (len)        (len)        (len)
th14_01.wav 00 00 00 10  01 3d 2f 60  00 2b ad d0  01 3d 2f 60  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
th14_02.wav 01 3d 2f 70  00 f9 29 00  00 15 d8 c0  00 f9 29 00  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
th14_03.wav 02 36 58 70  00 f1 30 00  00 06 51 80  00 f1 30 00  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
th14_04.wav 03 27 88 70  01 12 8a 70  00 29 24 80  01 12 8a 70  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
th14_05.wav 04 3a 12 e0  01 23 11 e0  00 05 a1 30  01 23 11 e0  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
th14_06.wav 05 5d 24 c0  01 85 c5 90  00 0f 02 f0  01 85 c5 90  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
th14_07.wav 06 e2 ea 50  01 1d 22 80  00 23 cf 40  01 1d 22 80  00 02 00 01  00 00 ac 44  00 02 b1 10  00 10 00 04  00 00 00 00
</code></pre></p>
<p>知道這些東西後就很方便了，接著就可以手動解出這些音樂，以下過程參考了這些資料 <a href="http://d.hatena.ne.jp/fgshun/20091025/1256447658">http://goo.gl/Z23iZ</a> ，者裡以解出第一首為例</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'> 1</span>
<span class='line-number'> 2</span>
<span class='line-number'> 3</span>
<span class='line-number'> 4</span>
<span class='line-number'> 5</span>
<span class='line-number'> 6</span>
<span class='line-number'> 7</span>
<span class='line-number'> 8</span>
<span class='line-number'> 9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span></pre></td><td class='code'><pre><code><span class='line'><span class="n">dat_path</span> <span class="o">=</span> <span class="s">ur&#39;thbgm.dat&#39;</span></span>
<span class='line'><span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">dat_path</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span></span>
<span class='line'><span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mh">0x10</span><span class="p">)</span>              <span class="c">#第二首就插入其 seek HEX</span></span>
<span class='line'><span class="n">intro</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mh">0x2badd0</span><span class="p">)</span>  <span class="c">#插入intro len HEX</span></span>
<span class='line'><span class="n">loop</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mh">0x1118190</span><span class="p">)</span>  <span class="c">#插入(full len)-(intro len) HEX</span></span>
<span class='line'><span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></span>
<span class='line'><span class="kn">import</span> <span class="nn">wave</span></span>
<span class='line'><span class="n">w</span> <span class="o">=</span> <span class="n">wave</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">u&#39;th14tr_01.wav&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span></span>
<span class='line'><span class="n">w</span><span class="o">.</span><span class="n">setnchannels</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></span>
<span class='line'><span class="n">w</span><span class="o">.</span><span class="n">setsampwidth</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></span>
<span class='line'><span class="n">w</span><span class="o">.</span><span class="n">setframerate</span><span class="p">(</span><span class="mi">44100</span><span class="p">)</span></span>
<span class='line'><span class="n">w</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">intro</span><span class="p">)</span></span>
<span class='line'><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span></span>
<span class='line'>    <span class="n">w</span><span class="o">.</span><span class="n">writeframes</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span></span>
<span class='line'><span class="n">w</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></span>
<span class='line'></span></code></pre></td></tr></table></div></figure>


<p>此時 wave 應該就可以聽了，先暫時筆記到此晚點看看能不能把整個 script 寫出來...</p>
  
</div>

<div class="meta">
  <div class="date">Sat Jun.  8 2013</div>
  <div class="tags">
    <a href='/archives/categories/%E6%9D%B1%E6%96%B9/'>東方</a>, 
    <a href='/archives/categories/python/'>python</a>, 
    <a href='/archives/categories/%E7%A8%8B%E5%BC%8F%E7%9B%B8%E9%97%9C/'>程式相關</a></div>
  
    <span class="comments"><a href="http://www.renn999.twbbs.org/archives/917/#disqus_thread">Comments</a></span>
  
</div>

    </article>
    
      <div class="share">
  <div class="addthis_toolbox addthis_default_style ">
  
  <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
  
  <a class="addthis_counter addthis_pill_style"></a>
  </div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>
    
    
    <section id="comment">
    <h1 class="title">Comments</h1>
    <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div>
    </section>
    

  </div>
  <footer id="footer" class="inner">
    Copyright &copy; 
    2013
    
        renn999
    
    Powered by <a href='https://github.com/renn999/PyBlogtle'>PyBlogtle</a>
    &amp; theme <a href='http://zespia.tw/Octopress-Theme-Slash/'>slash</a>
  </footer>
  <script src="/javascripts/slash.js"></script>
  <script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->
  
<script type="text/javascript">
      var disqus_shortname = 'rennidit';
      
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.renn999.twbbs.org/archives/917/';
        var disqus_url = 'http://www.renn999.twbbs.org/archives/917/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-12134531-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>

</body>
</html>